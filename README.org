#+TITLE: Ranking of average   treatment effects with generalized random forests for time-to-event outcomes: The empirical studies
#+Author: Helene Charlotti Wiese Rytgaard & Thomas Alexander Gerds

#+BEGIN_SRC R  :results silent  :exports none  :session *R* :cache no
try(setwd("~/research/SoftWare/grfCausalSearch/"),silent=TRUE)
library(targets)
library(tarchetypes)
library(Publish)
#+END_SRC

* Introduction

Here we provide the R-codes that (re)produce the simulation study
results presented in our manuscript. 


* Performance results

** Crude effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_crude = x[theme=="crude_effect"]
tabel_crude=x_crude[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_crude
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_crude)
#+END_SRC

:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  1.25 |  0.80 | 0.07 | 2.22 | 2.29 |     96.0 |
| causal_forest |   17.6 |  1.25 |  1.00 | 0.14 | 2.28 | 2.30 |     95.0 |
| causal_forest |   17.6 |  1.25 |  1.25 | 0.03 | 2.29 | 2.31 |     95.5 |
:end:

** Net effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_net = x[theme=="net_effect" & net==1]
tabel_net=x_net[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_net
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_net)
#+END_SRC

:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  0.80 |   0.8 | 0.60 | 2.27 | 2.24 |     93.9 |
| causal_forest |   17.6 |  1.00 |   0.8 | 0.53 | 2.23 | 2.31 |     95.5 |
| causal_forest |   17.6 |  1.25 |   0.8 | 0.68 | 2.28 | 2.37 |     95.9 |
:end:

** Boxplots

#+BEGIN_SRC R :results file graphics :file ./output/crude-net-effect-boxplots.png :exports none :session *R* :cache yes :width 500 :height 1000
b=tar_read(BOXPLOTS)
cowplot::plot_grid(b[[1]]+ggtitle("Crude effects"),b[[2]]+ggtitle("Net effects"),ncol = 1)
#+END_SRC


#+name: fig:1
#+CAPTION: 1000 estimates of crude and net effects
[[file:./output/crude-net-effect-boxplots.png]]

** Censoring percentage 

#+BEGIN_SRC R :results file graphics :file ./output/censoring-percentage-boxplots.png :exports none :session *R* :cache yes :width 500 :height 1000
x=tar_read(RESULTS)
x_censoring = x[theme=="censoring" ]
setkey(x_censoring,formula,censored.tau)
tabel_censoring=x_censoring[,.(method,formula,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_censoring
#+END_SRC


** Misspecified parametric models

#+BEGIN_SRC R :results file graphics :file ./output/misspecified-parametric-boxplots.png :exports none :session *R* :cache yes 
b=tar_read(BOXPLOTS)
b[[4]]
#+END_SRC


#+name: fig:2
#+CAPTION: Bias in parametric models that ignore a quadratic effect of a confounder variable 
[[file:./output/misspecified-parametric-boxplots.png]]
