#+TITLE: Ranking of average   treatment effects with generalized random forests for time-to-event outcomes: The empirical studies
#+Author: Helene Charlotti Wiese Rytgaard & Thomas Alexander Gerds

#+BEGIN_SRC R  :results silent  :exports none  :session *R* :cache no
try(setwd("~/research/SoftWare/grfCausalSearch/"),silent=TRUE)
library(targets)
library(tarchetypes)
library(Publish)
#+END_SRC

* Introduction

Here we provide the R-codes that (re)produce the simulation study
results presented in our manuscript.

* Simulation setting

** Data generation

We simulate 10 treatment variables, A1, ..., A10, five binary
predictor variables, X1, ..., X5, and two continuous predictor
variables, X6 and X7. 

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output raw drawer  :exports both  :session *R* :cache yes  
library(targets)
library(tarchetypes)
for(f in list.files("functions",".R$",full.names=TRUE)){source(f)}
source("setting/independent_targets.R")
set.seed(17)
d = simulateData(setting = independent_fixed,
                 A1_T1 = 1.25,
                 A1_T2 = 1,
                 A2_T1 = 1,
                 A2_T2 = 1.25,
                 n = 10,
                 scale.censored = 1/25,
                 keep.latent = TRUE)
out=d[,c(8,9,18:NCOL(d),1:7,10:17),with=FALSE]
org(out,digits=2)
#+END_SRC

#+RESULTS[(2022-06-06 09:02:03) 6b56810acfb52bde45c7d11c0ce05e06285dc12d]:
:results:
|   A1 |   A2 | T1_placebo_placebo | T1_treated_placebo | T1_placebo_treated | T1_treated_treated | T2_placebo_placebo | T2_treated_placebo | T2_placebo_treated | T2_treated_treated |    C |    T1 |    T2 | time | event |   X1 |   X2 |   X3 |   X4 |   X5 |     X6 |     X7 |   A3 |   A4 |   A5 |   A6 |   A7 |   A8 |   A9 |  A10 |
|------+------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+------+-------+-------+------+-------+------+------+------+------+------+--------+--------+------+------+------+------+------+------+------+------|
| 0.00 | 0.00 |               3.96 |               9.51 |               2.11 |               0.38 |               2.90 |               9.48 |               3.91 |               6.94 | 3.34 |  3.96 |  2.90 | 2.90 |  2.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 |  0.591 |  0.463 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 | 1.00 | 0.00 |
| 0.00 | 0.00 |               6.04 |               2.65 |              10.57 |               5.39 |               2.01 |              12.81 |               6.93 |               4.63 | 7.38 |  6.04 |  2.01 | 2.01 |  2.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -1.134 |  0.881 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 |
| 0.00 | 0.00 |              15.48 |               4.34 |               8.92 |               6.29 |              14.51 |              12.13 |               1.67 |               9.91 | 2.08 | 15.48 | 14.51 | 2.08 |  0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | -0.439 |  0.139 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 | 0.00 |
| 1.00 | 1.00 |               6.03 |               6.55 |              14.25 |               5.24 |              10.68 |              10.45 |               9.00 |              11.87 | 3.79 |  5.24 | 11.87 | 3.79 |  0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 |  0.345 | -0.375 | 1.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 |
| 1.00 | 1.00 |               2.98 |               5.93 |              11.63 |               1.78 |              10.81 |              26.45 |               8.78 |               4.08 | 3.23 |  1.78 |  4.08 | 1.78 |  1.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 | -0.449 |  0.043 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 |
| 1.00 | 0.00 |              14.36 |               5.22 |               2.18 |               2.81 |               5.83 |               3.75 |               4.41 |               3.05 | 6.78 |  5.22 |  3.75 | 3.75 |  2.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 |  0.044 |  0.634 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 | 1.00 | 0.00 |
| 1.00 | 0.00 |               6.71 |               5.33 |               1.92 |               2.90 |               2.91 |              17.37 |               9.24 |               8.91 | 6.94 |  5.33 | 17.37 | 5.33 |  1.00 | 0.00 | 0.00 | 1.00 | 1.00 | 1.00 | -0.568 | -1.707 | 0.00 | 0.00 | 1.00 | 0.00 | 1.00 | 0.00 | 1.00 | 0.00 |
| 1.00 | 1.00 |               7.74 |               5.71 |               4.22 |              13.21 |               3.58 |               4.45 |               8.11 |               4.07 | 4.04 | 13.21 |  4.07 | 4.04 |  0.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 |  1.825 |  0.020 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 | 0.00 | 1.00 | 0.00 |
| 0.00 | 0.00 |               8.94 |              15.32 |               7.49 |              10.30 |              14.28 |              13.10 |               8.05 |              10.61 | 7.42 |  8.94 | 14.28 | 7.42 |  0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 |  0.433 | -0.299 | 1.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 |
| 0.00 | 0.00 |               7.14 |               5.28 |               5.60 |              12.35 |              11.51 |               3.96 |              12.49 |              11.33 | 6.10 |  7.14 | 11.51 | 6.10 |  0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -1.354 | -0.442 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 |
:end:


** Scenarios

*** Independent right censoring

#+BEGIN_SRC R :results file graphics :file ./output/independent-setting.png :exports none :session *R* :cache yes
source("setting/independent_targets.R")
for(f in list.files("functions",".R$",full.names=TRUE)){source(f)}
set.seed(99)
d = simulateData(setting = independent_fixed,
                 A1_T1 = 1.25,
                 A1_T2 = 1,
                 A2_T1 = 1,
                 A2_T2 = 1.25,
                 n = 10000,
                 scale.censored = 1/25,
                 keep.latent = TRUE)
d[,dummy := rep(1,.N)]
d[,T_treated_placebo := pmin(T1_treated_placebo,T2_treated_placebo)]
d[,T_placebo_placebo := pmin(T1_placebo_placebo,T2_placebo_placebo)]
plot(prodlim(Hist(T1_placebo_placebo,dummy)~1,data=d,conf.int = FALSE),
     xlim = c(0,8),
     axis1.at=0:8,
     atrisk.at=c(0,2.5,5,7.5),
     type = "risk",
     plot.main = "Effect of A1 on latent cause 1")
legend(x = "topright",legend = c(0,1),title = "A1",
       col = c(1,"#E69F00"),lwd = c(2,2),cex = 1.5,bty = "n")
plot(prodlim(Hist(T1_treated_placebo,dummy)~1,data=d,conf.int = FALSE),
     add = TRUE,
     xlim = c(0,8),
     col = "#E69F00",
     type = "risk")
abline(v=5,col="gray77",lwd=3,lty=3)
#+END_SRC

#+RESULTS[(2022-06-06 08:28:19) 34abc88027cc6fb91c18ae3708973b4a84742008]:
[[file:./output/independent-setting.png]]

#+name: fig:1
#+ATTR_LATEX: :width 0.7\textwidth
#+CAPTION:
[[file:./output/independent-setting.png]]


* Performance


** Independent right censoring

*** Crude effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes  
xi=tar_read(INDEPENDENT_RESULTS)[intervene=="A1"&n==5000,.(method,"P(C<5)"=censored.tau,A1_T1,bias=round(100*bias,2),coverage=round(100*coverage,1))]
xi
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(xi)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:46) cb64047a2178fe4afceaada3d2624a5803813877]:
:results:
| method        | P(C<5) | A1_T1 |  bias | coverage |
|---------------+--------+-------+-------+----------|
| causal_forest |    0.0 |  1.00 | -0.36 |     94.0 |
| causal_forest |    0.0 |  1.25 | -0.29 |     93.0 |
| causal_forest |    0.0 |  1.50 | -0.49 |     92.5 |
| causal_forest |   34.1 |  1.00 | -0.32 |     94.5 |
| causal_forest |   34.1 |  1.25 |  0.11 |     92.5 |
| causal_forest |   34.1 |  1.50 |  0.10 |     94.0 |
| causal_forest |   47.3 |  1.00 | -0.17 |     93.5 |
| causal_forest |   47.3 |  1.25 |  0.35 |     97.5 |
| causal_forest |   47.3 |  1.50 |  0.58 |     93.5 |
:end:


#+BEGIN_SRC R :results file graphics :file ./output/independent-boxplots.png :exports none :session *R* :cache yes
tar_read(INDEPENDENT_BOXPLOTS)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:47) 4cd32117ad9c953b866082691cc0b821808ee1ea]:
[[file:./output/independent-boxplots.png]]

#+name: fig:1
#+ATTR_LATEX: :width 0.7\textwidth
#+CAPTION:
[[file:./output/independent-boxplots.png]]

*** Net effects

#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes  
xn=tar_read(NET_RESULTS)[intervene=="A1"&n==5000,.(method,"P(C<5)"=censored.tau,A1_T1,bias=round(100*bias,2),coverage=round(100*coverage,1))]
xn
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(xn)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:47) 1d0055ecb6239338437407fb5779d5e5afc38101]:
:results:
| method | P(C<5) | A1_T1 | bias | coverage |
|--------+--------+-------+------+----------|
Error in object[r, , drop = TRUE] : subscript out of bounds
:end:

** Dependent right censoring

#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes  
xd=tar_read(DEPENDENT_RESULTS)[n==5000,.(method,"P(C<3)"=censored.tau,intervene,A1_T1,bias=round(100*bias,2),coverage=round(100*coverage,1))]
xd
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(xd)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:48) 64957816025cd1b0e2bbc8dadf1428bb44035ae6]:
:results:
| method        | P(C<3) | intervene | A1_T1 |  bias | coverage |
|---------------+--------+-----------+-------+-------+----------|
| causal_forest |   28.3 | A1        |  1.00 | -0.60 |     94.5 |
| naive         |   28.3 | A1        |  1.00 | -4.97 |      1.5 |
| causal_forest |   28.3 | A1        |  1.25 | -0.66 |     93.5 |
| naive         |   28.3 | A1        |  1.25 | -5.56 |      0.5 |
| causal_forest |   28.3 | A1        |  1.50 | -0.95 |     91.0 |
| naive         |   28.3 | A1        |  1.50 | -6.17 |      1.0 |
| causal_forest |   28.3 | A2        |  1.00 | -0.10 |     96.0 |
| naive         |   28.3 | A2        |  1.00 | -0.05 |     94.0 |
| causal_forest |   28.3 | A2        |  1.25 |  0.13 |     94.5 |
| naive         |   28.3 | A2        |  1.25 |  0.10 |     94.5 |
| causal_forest |   28.3 | A2        |  1.50 | -0.08 |     94.0 |
| naive         |   28.3 | A2        |  1.50 | -0.12 |     94.0 |
:end:

#+BEGIN_SRC R :results file graphics :file ./output/dependent-boxplots.png :exports none :session *R* :cache yes
tar_read(DEPENDENT_BOXPLOTS)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:48) 74d08874d4ba43c98f3d9d685907c787f4812cdf]:
[[file:./output/dependent-boxplots.png]]


** Misspecified semi-parametric models


#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes  
xm=tar_read(MISSPECIFIED_RESULTS)[n==5000,.(method,"P(C<5)"=censored.tau,intervene,A1_T1,bias=round(100*bias,2),coverage=round(100*coverage,1))]
xm
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(xm)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:48) f05470148081dbc910113f688bdf1ef9760fda8e]:
:results:
| method        | P(C<5) | intervene | A1_T1 |  bias | coverage |
|---------------+--------+-----------+-------+-------+----------|
| causal_forest |   44.9 | A1        |  0.70 | -1.00 |     92.8 |
| CSC           |   44.9 | A1        |  0.70 |  1.90 |     76.0 |
| FGR           |   44.9 | A1        |  0.70 |  2.01 |       NA |
| naive         |   44.9 | A1        |  0.70 |  4.15 |     41.0 |
| causal_forest |   44.9 | A1        |  1.00 | -0.42 |     94.4 |
| CSC           |   44.9 | A1        |  1.00 |  1.48 |     84.0 |
| FGR           |   44.9 | A1        |  1.00 |  1.52 |       NA |
| naive         |   44.9 | A1        |  1.00 |  3.96 |     45.6 |
| causal_forest |   44.9 | A1        |  1.25 | -0.10 |     94.9 |
| CSC           |   44.9 | A1        |  1.25 |  1.24 |     87.7 |
| FGR           |   44.9 | A1        |  1.25 |  1.04 |       NA |
| naive         |   44.9 | A1        |  1.25 |  3.73 |     51.3 |
| causal_forest |   44.9 | A2        |  0.70 |  0.10 |     95.9 |
| CSC           |   44.9 | A2        |  0.70 |  0.06 |     96.1 |
| FGR           |   44.9 | A2        |  0.70 |  0.11 |       NA |
| naive         |   44.9 | A2        |  0.70 |  0.15 |     95.0 |
| causal_forest |   44.9 | A2        |  1.00 | -0.10 |     94.0 |
| CSC           |   44.9 | A2        |  1.00 | -0.11 |     93.1 |
| FGR           |   44.9 | A2        |  1.00 | -0.14 |       NA |
| naive         |   44.9 | A2        |  1.00 |  0.10 |     95.7 |
| causal_forest |   44.9 | A2        |  1.25 | -0.08 |     94.6 |
| CSC           |   44.9 | A2        |  1.25 | -0.15 |     94.3 |
| FGR           |   44.9 | A2        |  1.25 | -0.16 |       NA |
| naive         |   44.9 | A2        |  1.25 | -0.11 |     95.4 |
:end:

#+BEGIN_SRC R :results file graphics :file ./output/dependent-boxplots.png :exports none :session *R* :cache yes
tar_read(MISSPECIFIED_BOXPLOTS)
#+END_SRC

#+RESULTS[(2022-06-06 08:26:49) 58d685bd44aa73e0e1e10306f375b59d5b6bc65e]:
[[file:./output/dependent-boxplots.png]]
