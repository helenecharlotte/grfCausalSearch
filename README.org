#+TITLE: Ranking of average   treatment effects with generalized random forests for time-to-event outcomes: The empirical studies
#+Author: Helene Charlotti Wiese Rytgaard & Thomas Alexander Gerds

#+BEGIN_SRC R  :results silent  :exports none  :session *R* :cache no
try(setwd("~/research/SoftWare/grfCausalSearch/"),silent=TRUE)
library(targets)
library(tarchetypes)
library(Publish)
library(ggplot2)
library(data.table)
#+END_SRC


* Introduction

Here we provide the R-codes that (re)produce the simulation study
results presented in our manuscript. 

* Preparation

Clone the github repository and load (install if necessary) the following packages:

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes  
library(targets)
library(tarchetypes)
library(Publish)
#+END_SRC


* Performance results

** Crude effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_crude = x[theme=="crude_effect"]
tabel_crude=x_crude[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_crude
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_crude)
#+END_SRC

#+RESULTS[(2022-06-10 07:02:04) a66a92cde7e5c97f900778c0bb2514636450ee11]:
:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  1.25 |  0.80 | 0.05 | 2.19 | 2.29 |     95.3 |
| causal_forest |   17.6 |  1.25 |  1.00 | 0.14 | 2.22 | 2.29 |     95.7 |
| causal_forest |   17.6 |  1.25 |  1.25 | 0.03 | 2.23 | 2.31 |     95.4 |
:end:


** Net effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_net = x[theme=="net_effect" & net==1]
tabel_net=x_net[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_net
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_net)
#+END_SRC

#+RESULTS[(2022-06-10 17:28:23) 9b5ef84a8772ecb03367cf42518f1252962eeed8]:
:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  0.80 |   0.8 | 0.66 | 2.06 | 2.24 |     94.5 |
| causal_forest |   17.6 |  1.00 |   0.8 | 0.70 | 2.23 | 2.31 |     94.9 |
| causal_forest |   17.6 |  1.25 |   0.8 | 0.54 | 2.30 | 2.37 |     95.0 |
:end:

** Simulated performance boxplots

*** Crude and net effects

#+BEGIN_SRC R :results file graphics :file ./output/crude-net-effect-boxplots.png :exports none :session *R* :cache yes :width 500 :height 1000
b=tar_read(BOXPLOTS)
cowplot::plot_grid(b[[1]]+ggtitle("Crude effects"),b[[2]]+ggtitle("Net effects"),ncol = 1)
#+END_SRC


#+name: fig:1
#+CAPTION: 1000 estimates of crude and net effects
[[file:./output/crude-net-effect-boxplots.png]]


*** Sample size

#+BEGIN_SRC R :results file graphics :file ./output/sample-size-boxplots.png :exports none :session *R* :cache yes 
b=tar_read(BOXPLOTS)
b[[5]]
#+END_SRC

#+name: fig:2
#+CAPTION: Effect of sample size on the estimation performance.
[[file:./output/sample-size-boxplots.png]]

** Censoring percentage 

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output raw drawer  :exports code  :session *R* :cache yes  
x=tar_read(RESULTS)
x_censoring = x[theme=="censoring" ]
setkey(x_censoring,formula,censored.tau)
tabel_censoring=x_censoring[,.(method,formula,"P(C<3)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_censoring
#+END_SRC

#+RESULTS[(2022-06-10 17:27:04) 506e90d7b643046299ed144dde7450fa59cb4e89]:
:results:
          method      formula P(C<3) A1_T1 A1_T2  bias   SD   SE coverage
1: causal_forest     formula1    0.0  1.25     1 -0.36 1.35 1.32     93.1
2: causal_forest     formula1   17.6  1.25     1 -0.24 1.42 1.49     95.5
3: causal_forest     formula1   26.5  1.25     1 -0.16 1.54 1.56     94.1
4: causal_forest formula_cens    0.0  1.25     1 -0.29 1.29 1.32     94.7
5: causal_forest formula_cens   17.6  1.25     1 -0.29 1.43 1.48     95.2
6: causal_forest formula_cens   26.5  1.25     1 -0.34 1.55 1.54     93.5
:end:

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
org(tabel_censoring)
#+END_SRC

#+RESULTS[(2022-06-10 17:27:22) 4a675d5b8a3c93eabe0fc69383c7dc0fea14918c]:
:results:
| method        | formula      | P(C<3) | A1_T1 | A1_T2 |  bias |   SD |   SE | coverage |
|---------------+--------------+--------+-------+-------+-------+------+------+----------|
| causal_forest | formula1     |    0.0 |  1.25 |     1 | -0.36 | 1.35 | 1.32 |     93.1 |
| causal_forest | formula1     |   17.6 |  1.25 |     1 | -0.24 | 1.42 | 1.49 |     95.5 |
| causal_forest | formula1     |   26.5 |  1.25 |     1 | -0.16 | 1.54 | 1.56 |     94.1 |
| causal_forest | formula_cens |    0.0 |  1.25 |     1 | -0.29 | 1.29 | 1.32 |     94.7 |
| causal_forest | formula_cens |   17.6 |  1.25 |     1 | -0.29 | 1.43 | 1.48 |     95.2 |
| causal_forest | formula_cens |   26.5 |  1.25 |     1 | -0.34 | 1.55 | 1.54 |     93.5 |
:end:

** Misspecified parametric models

#+BEGIN_SRC R :results file graphics :file ./output/misspecified-parametric-boxplots.png :exports none :session *R* :cache yes 
b=tar_read(BOXPLOTS)
b[[4]]
#+END_SRC


#+name: fig:2
#+CAPTION: Bias in parametric models that ignore a quadratic effect of a confounder variable 
[[file:./output/misspecified-parametric-boxplots.png]]

** Ranking performance

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
estimate <- tar_read("ESTIMATE_ATE")
E=estimate[intervene%in%c("A2","A3"),.(intervene,ate,net,n,A2_T2)]
e=E[,.(ate=round(1000*mean(ate,na.rm=TRUE),1)),keyby=list(intervene,net,n,A2_T2)]
e[n==5000&A2_T2==.2]
E[n==5000&A2_T2==.2,median(ate,na.rm=TRUE),keyby=.(net,intervene)]
E23[net==0,boxplot(ate~intervene)]
estimate[,net:=factor(net,levels=c(0,1),labels=c("Crude","Net"))]
ggplot(estimate[n==5000&A2_T2==2&intervene=="A2"],aes(y=ate,group=factor(net),color=net))+geom_boxplot()
ggplot(estimate[n==5000&A2_T2==2&net=="Crude"&intervene%in%c("A2","A3")],aes(y=ate,group=factor(intervene),color=intervene))+geom_boxplot()
#+END_SRC


#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
estimate <- tar_read("ESTIMATE_ATE")
truth <- tar_read("TRUTH")
x2=summarizePerformance(truth,estimate,variable="A2")[theme=="ranking"]
x2[,c("censored.tau","net","n","A2_T1","A2_T2","true.ate","mean.ate","bias")]
#+END_SRC


#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output raw drawer  :exports both  :session *R* :cache yes
## estimate <- tar_read("ESTIMATE_ATE")
## estimate = estimate[!is.na(rank)]
## ran = estimate[theme == "ranking",.(rank = 1:10,mean = sapply(1:10,function(r)mean(rank == r))),by = c("net","intervene","n","A2_T2")]
ran <- tar_read(RANKING)
ran[,net:=factor(net,levels=c(0,1),labels=c("Crude","Net"))]
ran[n==5000&A2_T2==2&net=="Crude"&intervene%in%c("A2","A3")]
ran[n==5000&A2_T2==.2&net=="Crude"&intervene%in%c("A2","A3")]
ran=ran[intervene%in%c("A2","A3","A7")]
gnet=ggplot(ran[net==1&rank==2],aes(x=n,y=mean,color=intervene,group=intervene))+geom_line()+geom_point()+facet_grid(~A2_T2)
gcrude=ggplot(ran[net==0&rank==2],aes(x=n,y=mean,color=intervene,group=intervene))+geom_line()+geom_point()+facet_grid(~A2_T2)
## gnet=ggplot(ran[net==1&intervene%in%c("A1","A2","A5")&rank==2],aes(x=n,y=mean,color=intervene,group=intervene))+geom_line()+geom_point()+facet_grid(~A2_T2)
## gcrude=ggplot(ran[net==0&intervene%in%c("A1","A2","A5")&rank==2],aes(x=n,y=mean,color=intervene,group=intervene))+geom_line()+geom_point()+facet_grid(~A2_T2)
cowplot::plot_grid(gcrude+ggtitle("Crude effects"),gnet+ggtitle("Net effects"),ncol = 1)
#+END_SRC
