#+TITLE: Ranking of average   treatment effects with generalized random forests for time-to-event outcomes: The empirical studies
#+Author: Helene Charlotti Wiese Rytgaard & Thomas Alexander Gerds

#+BEGIN_SRC R  :results silent  :exports none  :session *R* :cache no
try(setwd("~/research/SoftWare/grfCausalSearch/"),silent=TRUE)
library(targets)
library(tarchetypes)
library(Publish)
#+END_SRC

* Introduction

Here we provide the R-codes that (re)produce the simulation study
results presented in our manuscript. 

* Simulation setting

** Data generation

We simulate 10 treatment variables, A1, ..., A10, five binary
predictor variables, X1, ..., X5, and two continuous predictor
variables, X6 and X7. 

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output raw drawer  :exports both  :session *R* :cache yes  
library(targets)
library(tarchetypes)
for(f in list.files("functions",".R$",full.names=TRUE)){source(f)}
source("setting/independent_targets.R")
set.seed(17)
d = simulateData(setting = independent_fixed,
                 A1_T1 = 1.25,
                 A1_T2 = 1,
                 A2_T1 = 1,
                 A2_T2 = 1.25,
                 n = 10,
                 scale.censored = 1/25,
                 keep.latent = TRUE)
out=d[,c(8,9,18:NCOL(d),1:7,10:17),with=FALSE]
org(out,digits=2)
#+END_SRC

#+RESULTS[(2022-06-06 09:02:03) 6b56810acfb52bde45c7d11c0ce05e06285dc12d]:
:results:
|   A1 |   A2 | T1_placebo_placebo | T1_treated_placebo | T1_placebo_treated | T1_treated_treated | T2_placebo_placebo | T2_treated_placebo | T2_placebo_treated | T2_treated_treated |    C |    T1 |    T2 | time | event |   X1 |   X2 |   X3 |   X4 |   X5 |     X6 |     X7 |   A3 |   A4 |   A5 |   A6 |   A7 |   A8 |   A9 |  A10 |
|------+------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+--------------------+------+-------+-------+------+-------+------+------+------+------+------+--------+--------+------+------+------+------+------+------+------+------|
| 0.00 | 0.00 |               3.96 |               9.51 |               2.11 |               0.38 |               2.90 |               9.48 |               3.91 |               6.94 | 3.34 |  3.96 |  2.90 | 2.90 |  2.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 |  0.591 |  0.463 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 | 1.00 | 0.00 |
| 0.00 | 0.00 |               6.04 |               2.65 |              10.57 |               5.39 |               2.01 |              12.81 |               6.93 |               4.63 | 7.38 |  6.04 |  2.01 | 2.01 |  2.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -1.134 |  0.881 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 |
| 0.00 | 0.00 |              15.48 |               4.34 |               8.92 |               6.29 |              14.51 |              12.13 |               1.67 |               9.91 | 2.08 | 15.48 | 14.51 | 2.08 |  0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | -0.439 |  0.139 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 | 0.00 |
| 1.00 | 1.00 |               6.03 |               6.55 |              14.25 |               5.24 |              10.68 |              10.45 |               9.00 |              11.87 | 3.79 |  5.24 | 11.87 | 3.79 |  0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 |  0.345 | -0.375 | 1.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 |
| 1.00 | 1.00 |               2.98 |               5.93 |              11.63 |               1.78 |              10.81 |              26.45 |               8.78 |               4.08 | 3.23 |  1.78 |  4.08 | 1.78 |  1.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 | -0.449 |  0.043 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 |
| 1.00 | 0.00 |              14.36 |               5.22 |               2.18 |               2.81 |               5.83 |               3.75 |               4.41 |               3.05 | 6.78 |  5.22 |  3.75 | 3.75 |  2.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 |  0.044 |  0.634 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 1.00 | 1.00 | 0.00 |
| 1.00 | 0.00 |               6.71 |               5.33 |               1.92 |               2.90 |               2.91 |              17.37 |               9.24 |               8.91 | 6.94 |  5.33 | 17.37 | 5.33 |  1.00 | 0.00 | 0.00 | 1.00 | 1.00 | 1.00 | -0.568 | -1.707 | 0.00 | 0.00 | 1.00 | 0.00 | 1.00 | 0.00 | 1.00 | 0.00 |
| 1.00 | 1.00 |               7.74 |               5.71 |               4.22 |              13.21 |               3.58 |               4.45 |               8.11 |               4.07 | 4.04 | 13.21 |  4.07 | 4.04 |  0.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 |  1.825 |  0.020 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 | 0.00 | 1.00 | 0.00 |
| 0.00 | 0.00 |               8.94 |              15.32 |               7.49 |              10.30 |              14.28 |              13.10 |               8.05 |              10.61 | 7.42 |  8.94 | 14.28 | 7.42 |  0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 |  0.433 | -0.299 | 1.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 | 0.00 | 1.00 |
| 0.00 | 0.00 |               7.14 |               5.28 |               5.60 |              12.35 |              11.51 |               3.96 |              12.49 |              11.33 | 6.10 |  7.14 | 11.51 | 6.10 |  0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | -1.354 | -0.442 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 0.00 | 1.00 | 0.00 |
:end:


** Scenarios

*** Crude effects 

#+BEGIN_SRC R :results file graphics :file ./output/independent-setting.png :exports none :session *R* :cache yes
source("setting/independent_targets.R")
for(f in list.files("functions",".R$",full.names=TRUE)){source(f)}
set.seed(99)
d = simulateData(setting = independent_fixed,
                 A1_T1 = 1.25,
                 A1_T2 = 1,
                 A2_T1 = 1,
                 A2_T2 = 1.25,
                 n = 10000,
                 scale.censored = 1/25,
                 keep.latent = TRUE)
d[,dummy := rep(1,.N)]
d[,T_treated_placebo := pmin(T1_treated_placebo,T2_treated_placebo)]
d[,T_placebo_placebo := pmin(T1_placebo_placebo,T2_placebo_placebo)]
plot(prodlim(Hist(T1_placebo_placebo,dummy)~1,data=d,conf.int = FALSE),
     xlim = c(0,8),
     axis1.at=0:8,
     atrisk.at=c(0,2.5,5,7.5),
     type = "risk",
     plot.main = "Effect of A1 on latent cause 1")
legend(x = "topright",legend = c(0,1),title = "A1",
       col = c(1,"#E69F00"),lwd = c(2,2),cex = 1.5,bty = "n")
plot(prodlim(Hist(T1_treated_placebo,dummy)~1,data=d,conf.int = FALSE),
     add = TRUE,
     xlim = c(0,8),
     col = "#E69F00",
     type = "risk")
abline(v=5,col="gray77",lwd=3,lty=3)
#+END_SRC

#+RESULTS[(2022-06-06 08:28:19) 34abc88027cc6fb91c18ae3708973b4a84742008]:
[[file:./output/independent-setting.png]]

#+name: fig:1
#+ATTR_LATEX: :width 0.7\textwidth
#+CAPTION:
[[file:./output/independent-setting.png]]


* Performance


** Crude effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_crude = x[theme=="crude_effect"]
tabel_crude=x_crude[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_crude
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_crude)
#+END_SRC

#+RESULTS[(2022-06-07 18:28:22) a66a92cde7e5c97f900778c0bb2514636450ee11]:
:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  1.25 |  0.80 | 0.07 | 2.22 | 2.29 |     96.0 |
| causal_forest |   17.6 |  1.25 |  1.00 | 0.14 | 2.28 | 2.30 |     95.0 |
| causal_forest |   17.6 |  1.25 |  1.25 | 0.03 | 2.29 | 2.31 |     95.5 |
:end:

** Net effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_net = x[theme=="net_effect" & net==1]
tabel_net=x_net[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_net
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_net)
#+END_SRC

#+RESULTS[(2022-06-07 18:31:24) 9b5ef84a8772ecb03367cf42518f1252962eeed8]:
:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  0.80 |   0.8 | 0.60 | 2.27 | 2.24 |     93.9 |
| causal_forest |   17.6 |  1.00 |   0.8 | 0.53 | 2.23 | 2.31 |     95.5 |
| causal_forest |   17.6 |  1.25 |   0.8 | 0.68 | 2.28 | 2.37 |     95.9 |
:end:

** Boxplots

#+BEGIN_SRC R :results file graphics :file ./output/crude-net-effect-boxplots.png :exports none :session *R* :cache yes :width 500 :height 1000
b=tar_read(BOXPLOTS)
cowplot::plot_grid(b[[1]]+ggtitle("Crude effects"),b[[2]]+ggtitle("Net effects"),ncol = 1)
#+END_SRC

#+RESULTS[(2022-06-07 18:43:05) ee567d5b06de7a47be7dbced30e52d5dd3ce99d9]:
[[file:./output/crude-net-effect-boxplots.png]]

#+name: fig:1
#+CAPTION: 1000 estimates of crude and net effects
[[file:./output/crude-net-effect-boxplots.png]]

** Censoring percentage 

#+BEGIN_SRC R :results file graphics :file ./output/censoring-percentage-boxplots.png :exports none :session *R* :cache yes :width 500 :height 1000
x=tar_read(RESULTS)
x_censoring = x[theme=="censoring" ]
setkey(x_censoring,formula,censored.tau)
tabel_censoring=x_censoring[,.(method,formula,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_censoring
#+END_SRC


** Misspecified parametric models

#+BEGIN_SRC R :results file graphics :file ./output/misspecified-parametric-boxplots.png :exports none :session *R* :cache yes 
b=tar_read(BOXPLOTS)
b[[4]]
#+END_SRC

#+RESULTS[(2022-06-07 19:02:05) fed0e23230ea7f045908df9e6322d90eeea3f8c1]:
[[file:./output/misspecified-parametric-boxplots.png]]

#+name: fig:2
#+CAPTION: Bias in parametric models that ignore a quadratic effect of a confounder variable 
[[file:./output/misspecified-parametric-boxplots.png]]
