#+TITLE: Ranking of average treatment effects with generalized random forests for time-to-event outcomes: The empirical studies
#+Author: Helene Charlotti Wiese Rytgaard & Thomas Alexander Gerds

#+BEGIN_SRC R  :results silent  :exports none  :session *R* :cache no
try(setwd("~/research/SoftWare/grfCausalSearch/"),silent=TRUE)
#+END_SRC


* Introduction

Here we provide the R-codes that (re)produce the simulation study
results presented in our manuscript.

* Preparation

Clone the github repository, then load (and install first if
necessary) the following packages:

#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes  
library(targets)
library(tarchetypes)
library(Publish)
library(data.table)
library(ggplot2)
library(parallel)
library(ranger)
library(prodlim)
library(grf)
library(survival)
#+END_SRC

Source the R-functions

#+BEGIN_SRC R  :results output raw  :exports code  :session *R* :cache yes  
# load all functions
for(f in list.files("R",".R$",full.names=TRUE)){source(f)}
for(f in list.files("functions",".R$",full.names=TRUE)){source(f)}
source("./setting/simulation_targets.R")
#+END_SRC

* Demo

** Simulate data

The function =simulateData= simulates 3 latent event times, one for
each of 2 causes, and one for the right censoring time. The minimum of
the three latent times is given in the column =time=. The event type
is in the column =event= where value =0= codes for right censored, =1=
event of cause 1 and =2= event of cause 2. The distributions of the
latent times depends on five discrete (varying prevalence) and two
continuous covariates and ten binary treatment variables (varying
prevalence) as defined by the current setting.

#+BEGIN_SRC R  :results output example  :exports both  :session *R* :cache yes  
fixed
#+END_SRC

#+RESULTS[(2022-06-23 08:53:26) 5c4139cacd7e0e312bba25817204e8572ef8bf14]:
#+begin_example
$event.times
[1] "T1" "T2"

$treatments
 A1  A2  A3  A4  A5  A6  A7  A8  A9 A10 
0.4 0.3 0.3 0.4 0.5 0.2 0.7 0.8 0.9 0.1 

$binary.covariates
 X1  X2  X3  X4  X5 
0.1 0.2 0.3 0.4 0.5 

$normal.covariates
[1] "X6" "X7"

$quadratic.covariates
[1] "X6"
#+end_example

The dependence of all the variables is defined by a set of formula. Here the values are
hazard and odds ratios specified on the logarithmic scale.
#+BEGIN_SRC R  :results output example  :exports both  :session *R* :cache yes  
formula1
#+END_SRC

#+RESULTS[(2022-06-23 08:54:41) 7c78430e442837b5fe50d61112cf7fde919a362a]:
#+begin_example
[[1]]
T1 ~ f(A4, 0.3) + f(A5, 0.7) + f(X1, 1) + f(X2, 0.3) + f(X6, 
    -0.5)

[[2]]
T2 ~ f(A5, -0.3) + f(X1, -0.1) + f(X2, 0.6) + f(X6, 0.1)

[[3]]
C ~ f(A1, 0)

[[4]]
A1 ~ f(X1, -1) + f(X6, 0.7) + f(A7, 0.2)
#+end_example

Furthermore, the effect of the treatments =A1= and =A2= on the latent
event times are controlled by hazard ratio parameters denoted =A1_T1=,
=A1_T2=, =A2_T1=, =A2_T2=.  Finally, the baseline hazard rate of the
censoring distribution is controlled by the parameter
=scale.censored=.

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output example  :exports both  :session *R* :cache yes
set <- fixed
set$formula.list <- formula1
set.seed(9)
simulated_data <- simulateData(setting = set,
                     A1_T1 = 1.25,
                     A1_T2 = 1.25,
                     A2_T1 = 1,
                     A2_T2 = .8,
                     n = 2000,
                     scale.censored = 1/40,
                     keep.latent = FALSE)
simulated_data
#+END_SRC

#+RESULTS[(2022-06-23 09:17:49) 732837749fac309bf47b5de3030d435c697570cf]:
#+begin_example
      X1 X2 X3 X4 X5        X6         X7       X6_2 A1 A2 A3 A4 A5 A6 A7 A8 A9 A10      time event
   1:  0  0  0  1  0  1.366917  0.4820531 1.86846333  0  1  0  0  1  0  0  1  1   0 1.5739140     1
   2:  0  0  0  0  1 -1.271084  1.2153707 1.61565345  0  0  0  0  1  0  0  1  0   0 2.9788801     1
   3:  0  0  1  1  1 -1.364074 -2.6193556 1.86069689  0  0  0  1  0  0  0  0  0   0 1.2442290     1
   4:  1  1  0  0  0  1.386565  0.1932862 1.92256317  0  1  0  1  0  0  1  1  1   0 2.1995066     1
   5:  0  0  0  0  1 -1.775040  2.4391927 3.15076806  0  1  0  0  0  0  1  1  0   0 3.0073309     1
  ---                                                                                              
1996:  0  0  0  0  1  1.188219 -1.2651380 1.41186532  1  0  0  0  0  0  0  0  0   0 1.9685047     0
1997:  0  0  0  0  1  1.170084  0.1322747 1.36909754  1  1  0  0  0  0  0  0  1   0 6.8648901     0
1998:  0  0  0  1  1 -0.127420 -0.4530185 0.01623587  0  1  0  0  1  1  0  1  1   0 0.1371714     0
1999:  0  0  1  0  0  0.667086 -1.1179058 0.44500368  0  0  1  0  1  0  0  0  0   0 0.6471192     0
2000:  0  0  0  0  1  2.026630 -0.3432982 4.10722802  0  0  0  1  0  1  0  1  1   1 6.0341619     0
#+end_example

** True value of the average treatment effects

We approximate the true values of the crude and net average treatment
effects at the time horizon as well as the percentage of censored
*before* the time horizon. We do this by simulating large datasets in
the setting where the treatments =A1= and =A2= are randomized. To
minimize Monte-Carlo error, we repeat this =10= times and report
averages.

#+BEGIN_SRC R  :results output raw drawer  :exports both  :session *R* :cache yes
set.seed(7)
tt=theTruth(setting = set,
         A1_T1 = 1.25,
         A1_T2 = 1.25,
         A2_T1 = 1,
         A2_T2 = .8,
         B=10, # number of repetitions
         horizon=5,
         scale.censored=1/40,
         n = 100000)
tt[cause==1]
#+END_SRC

#+RESULTS[(2022-06-23 09:16:25) 30e46c2b569824a41c0e9214eddf9a95886e5577]:
:results:
   intervene cause net scale.censored      ate censored.tau
1:        A1     1   1          0.025 0.059851        33.78
2:        A2     1   1          0.025 0.000553        33.78
3:        A1     1   0          0.025 0.045465        33.78
4:        A2     1   0          0.025 0.006996        33.78
:end:

The crude effect of =A1= is larger than the net effect because =A1=
increases the hazard rate of events of cause 2 and hence subjects are
shorter time at risk for cause 1.

** Estimator

*** Single treatment: crude
#+BEGIN_SRC R  :results output raw drawer  :exports both  :session *R* :cache yes  
set.seed(4)
x <- causalhunter(formula=Hist(time,event)~intervene(A1)+A2+A3+A4+A5+A6+A7+A8+A9+A10+X1+X2+X3+X4+X5+X6+X7,
               method = "causal_forest",
               weighter="ranger",
               args.weight = list(num.trees = 100,alpha = 0.05,mtry = 17), # arguments for weighter
               fit.separate = TRUE, # fit G and G2 separately
               num.trees=100, # number of trees for the function causal_forest
               CR.as.censoring = 0, # 0 = crude effects, 1 = net effects
               data=simulated_data,
               times=5, # time horizon
               formula.weight = Hist(time,event)~A1+A2+A3+A4+A5+A6+A7+A8+A9+A10+X1+X2+X3+X4+X5+X6+X7)
set(x,j="true.ate",value=tt[intervene=="A1"&net==0&cause==1,ate])
x
#+END_SRC

#+RESULTS[(2022-06-23 09:14:14) 11e3fcc3fa0578f5eee876342e27f8ad4688f45f]:
:results:
   time intervene        ate        se       lower     upper true.ate
1:    5        A1 0.04893297 0.0310279 -0.01188059 0.1097465 0.045465
:end:

*** Single treatment: net
#+BEGIN_SRC R  :results output raw drawer  :exports both  :session *R* :cache yes  
set.seed(4)
y <- causalhunter(formula=Hist(time,event)~intervene(A1)+A2+A3+A4+A5+A6+A7+A8+A9+A10+X1+X2+X3+X4+X5+X6+X7,
                  method = "causal_forest",
                  weighter="ranger",
                  args.weight = list(num.trees = 100,alpha = 0.05,mtry = 17), # arguments for weighter
                  fit.separate = TRUE, # fit G and G2 separately
                  num.trees=100, # number of trees for the function causal_forest
                  CR.as.censoring = 1, # 0 = crude effects, 1 = net effects
                  data=simulated_data,
                  times=5, # time horizon 
                  formula.weight = Hist(time,event)~A1+A2+A3+A4+A5+A6+A7+A8+A9+A10+X1+X2+X3+X4+X5+X6+X7)
set(y,j="true.ate",value=tt[intervene=="A1"&net==1&cause==1,ate])
y
#+END_SRC

#+RESULTS[(2022-06-23 09:39:59) 175d19d2bf35b4d9188ec95c4c05c58b058e409d]:
:results:
   time intervene        ate         se       lower     upper true.ate
1:    5        A1 0.05933079 0.03621768 -0.01165456 0.1303161 0.059851
:end:

* Empirical studies

Our empirical studies are organized with the help of the magnificent
package =targets=, see https://books.ropensci.org/targets/. The
simulation settings are defined in the file
[[./setting/simulation_targets.R]] and run by the master file
[[./_targets.R]]. The results are saved and can be assessed by the
function =tar_read= as is shown below.

** Performance results

*** Crude effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_crude = x[theme=="crude_effect"]
tabel_crude=x_crude[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_crude
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_crude)
#+END_SRC

#+RESULTS[(2022-06-10 07:02:04) a66a92cde7e5c97f900778c0bb2514636450ee11]:
:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  1.25 |  0.80 | 0.05 | 2.19 | 2.29 |     95.3 |
| causal_forest |   17.6 |  1.25 |  1.00 | 0.14 | 2.22 | 2.29 |     95.7 |
| causal_forest |   17.6 |  1.25 |  1.25 | 0.03 | 2.23 | 2.31 |     95.4 |
:end:


*** Net effects
#+BEGIN_SRC R  :results silent  :exports code  :session *R* :cache yes
x=tar_read(RESULTS)
x_net = x[theme=="net_effect" & net==1]
tabel_net=x_net[,.(method,"P(C<5)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_net
#+END_SRC

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
Publish::org(tabel_net)
#+END_SRC

#+RESULTS[(2022-06-10 17:28:23) 9b5ef84a8772ecb03367cf42518f1252962eeed8]:
:results:
| method        | P(C<5) | A1_T1 | A1_T2 | bias |   SD |   SE | coverage |
|---------------+--------+-------+-------+------+------+------+----------|
| causal_forest |   17.6 |  0.80 |   0.8 | 0.66 | 2.06 | 2.24 |     94.5 |
| causal_forest |   17.6 |  1.00 |   0.8 | 0.70 | 2.23 | 2.31 |     94.9 |
| causal_forest |   17.6 |  1.25 |   0.8 | 0.54 | 2.30 | 2.37 |     95.0 |
:end:

*** Simulated performance boxplots

**** Crude and net effects

#+BEGIN_SRC R :results file graphics :file ./output/crude-net-effect-boxplots.png :exports none :session *R* :cache yes :width 500 :height 1000
b=tar_read(BOXPLOTS)
cowplot::plot_grid(b[[1]]+ggtitle("Crude effects"),b[[2]]+ggtitle("Net effects"),ncol = 1)
#+END_SRC

#+RESULTS[(2022-06-23 08:27:09) ee567d5b06de7a47be7dbced30e52d5dd3ce99d9]:
[[file:./output/crude-net-effect-boxplots.png]]


#+name: fig:1
#+CAPTION: 1000 estimates of crude and net effects
[[file:./output/crude-net-effect-boxplots.png]]


**** Sample size

#+BEGIN_SRC R :results file graphics :file ./output/sample-size-boxplots.png :exports none :session *R* :cache yes 
b=tar_read(BOXPLOTS)
b[[5]]
#+END_SRC

#+RESULTS[(2022-06-23 08:27:10) 274bfa2c604c157f2281f7cad3d938736e617b75]:
[[file:./output/sample-size-boxplots.png]]

#+name: fig:2
#+CAPTION: Effect of sample size on the estimation performance.
[[file:./output/sample-size-boxplots.png]]

*** Censoring percentage 

#+ATTR_LATEX: :options otherkeywords={}, deletekeywords={}
#+BEGIN_SRC R  :results output raw drawer  :exports code  :session *R* :cache yes  
x=tar_read(RESULTS)
x_censoring = x[theme=="censoring" ]
setkey(x_censoring,formula,censored.tau)
tabel_censoring=x_censoring[,.(method,formula,"P(C<3)"=round(censored.tau,1),A1_T1,A1_T2,bias=round(100*bias,2),SD=round(100*sd,2),SE=round(100*mean.se,2),coverage=round(100*coverage,1))]
tabel_censoring
#+END_SRC

#+RESULTS[(2022-06-23 08:27:10) fca1c9378d9092361da537643a0128b6aeba4edc]:
:results:
          method      formula P(C<3) A1_T1 A1_T2  bias   SD   SE coverage
1: causal_forest     formula1    0.0  1.25     1 -0.39 1.31 1.32     93.3
2: causal_forest     formula1   17.6  1.25     1 -0.10 1.48 1.49     95.3
3: causal_forest     formula1   26.5  1.25     1 -0.28 1.49 1.55     95.9
4: causal_forest formula_cens    0.0  1.25     1 -0.33 1.31 1.32     94.3
5: causal_forest formula_cens   17.6  1.25     1 -0.30 1.48 1.48     94.3
6: causal_forest formula_cens   26.5  1.25     1 -0.38 1.54 1.54     93.8
:end:

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes  
org(tabel_censoring)
#+END_SRC

#+RESULTS[(2022-06-10 17:27:22) 4a675d5b8a3c93eabe0fc69383c7dc0fea14918c]:
:results:
| method        | formula      | P(C<3) | A1_T1 | A1_T2 |  bias |   SD |   SE | coverage |
|---------------+--------------+--------+-------+-------+-------+------+------+----------|
| causal_forest | formula1     |    0.0 |  1.25 |     1 | -0.36 | 1.35 | 1.32 |     93.1 |
| causal_forest | formula1     |   17.6 |  1.25 |     1 | -0.24 | 1.42 | 1.49 |     95.5 |
| causal_forest | formula1     |   26.5 |  1.25 |     1 | -0.16 | 1.54 | 1.56 |     94.1 |
| causal_forest | formula_cens |    0.0 |  1.25 |     1 | -0.29 | 1.29 | 1.32 |     94.7 |
| causal_forest | formula_cens |   17.6 |  1.25 |     1 | -0.29 | 1.43 | 1.48 |     95.2 |
| causal_forest | formula_cens |   26.5 |  1.25 |     1 | -0.34 | 1.55 | 1.54 |     93.5 |
:end:

*** Misspecified parametric models

#+BEGIN_SRC R :results file graphics :file ./output/misspecified-parametric-boxplots.png :exports none :session *R* :cache yes 
b=tar_read(BOXPLOTS)
b[[4]]
#+END_SRC

#+RESULTS[(2022-06-23 08:27:11) fed0e23230ea7f045908df9e6322d90eeea3f8c1]:
[[file:./output/misspecified-parametric-boxplots.png]]


#+name: fig:2
#+CAPTION: Bias in parametric models that ignore a quadratic effect of a confounder variable 
[[file:./output/misspecified-parametric-boxplots.png]]

*** Ranking performance

#+BEGIN_SRC R :results file graphics :file ./output/ranking-performance.png :exports none :session *R* :cache yes
ran <- tar_read(RANKING)[A2_T2%in%c(0.2,1,2)]
ran[,net:=factor(net,levels=c(0,1),labels=c("Crude","Net"))]
gnet=ggplot(ran[net=="Net"&intervene%in%c("A1","A2","A3")&rank==1],aes(x=n,y=mean,linetype=intervene,group=intervene))+geom_line()+geom_point()+facet_grid(~A2_T2)+ylim(c(0,1))+ylab("Frequency of rank 1")
gcrude=ggplot(ran[net=="Crude"&intervene%in%c("A1","A2","A3")&rank==1],aes(x=n,y=mean,linetype=intervene,group=intervene))+geom_line()+geom_point()+facet_grid(~A2_T2)+ylim(c(0,1))+ylab("Frequency of rank 1")
cowplot::plot_grid(gcrude+ggtitle("Crude effects"),gnet+ggtitle("Net effects"),ncol = 1)
#+END_SRC

#+RESULTS[(2022-06-23 08:21:28) 523fd7bdc63d549623ee58f9a68a89b166eacc1d]:
[[file:./output/ranking-performance.png]]

#+name: fig:1
#+ATTR_LATEX: :width 0.7\textwidth
#+CAPTION:
[[file:./output/ranking-performance.png]]

